<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Sistema de impress√£o de etiquetas 60x40mm para produtos aliment√≠cios" />
  <meta name="theme-color" content="#121827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Etiquetas" />
  <title>Impress√£o de Etiquetas (60x40 mm)</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/svg+xml" href="icon.svg" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  
  <link rel="stylesheet" href="etiquetas.css" />
  <!-- Libs for codes -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <main class="app">
    <section class="controls">
      <h1>Etiquetas Inteligentes 60x40</h1>
      <div class="grid">
        <label class="full">
          <span>Produto</span>
          <select id="productSelect"></select>
        </label>
        <label>
          <span>Fabrica√ß√£o</span>
          <input id="mfgDate" type="date" />
        </label>
        <div class="validity">
          <label>
            <span>Validade</span>
            <input id="expDate" type="date" />
          </label>
          <div class="quick-terms">
            <button class="chip" data-term="5d">5 dias</button>
            <button class="chip" data-term="7d">7 dias</button>
            <button class="chip" data-term="15d">15 dias</button>
            <button class="chip" data-term="30d">30 dias</button>
            <button class="chip" data-term="3m">3 meses</button>
          </div>
          <label class="auto-valid">
            <input type="checkbox" id="useAutoValidity" checked /> Usar validade padr√£o do produto (se houver)
          </label>
        </div>
        <label class="full">
          <span>Observa√ß√µes (opcional)</span>
          <input id="notes" placeholder="ex.: Sem lactose / Turno B" />
        </label>
        <label class="full">
          <span>Tamanho do papel</span>
          <select id="paperSize">
            <option value="60mm">60mm (padr√£o)</option>
            <option value="55mm">55mm (5.5cm)</option>
          </select>
        </label>
        <div class="full batch">
          <label>
            <span>Quantidade</span>
            <input id="qty" type="number" min="1" value="1" />
          </label>
          <div class="actions">
            <button id="addToQueueBtn">Adicionar √† fila</button>
            <button id="clearQueueBtn">Limpar fila</button>
          </div>
        </div>
        <div class="actions">
          <button id="printBtn" class="primary">Imprimir</button>
          <button id="printQueueBtn" class="primary">Imprimir fila</button>
          <button id="savePresetBtn">Salvar como atalho</button>
          <button id="exportHistoryBtn">Exportar hist√≥rico</button>
        </div>
      </div>

      <div class="presets">
        <h2>Atalhos de impress√£o</h2>
        <div id="presetsList" class="preset-list"></div>
      </div>

      <div class="history">
        <h2>Hist√≥rico</h2>
        <div id="historyList" class="history-list"></div>
      </div>
    </section>

    <section class="preview-panel">
      <h2>Pr√©via 1:1 (60x40 mm)</h2>
      <div class="preview">
        <div id="label" class="label">
          <div class="label-box">
            <div class="line-row">
              <div class="line-title">Produto:</div>
              <div class="line-fill"><span id="lineProduct">‚Äî</span></div>
            </div>
            <div class="line-row">
              <div class="line-title">Fabrica√ß√£o:</div>
              <div class="date-fill">
                <div class="date-seg" id="mfgDD">&nbsp;</div>
                <div class="slash">/</div>
                <div class="date-seg" id="mfgMM">&nbsp;</div>
                <div class="slash">/</div>
                <div class="date-seg" id="mfgYY">&nbsp;</div>
              </div>
            </div>
            <div class="line-row">
              <div class="line-title">Validade:</div>
              <div class="date-fill">
                <div class="date-seg" id="expDD">&nbsp;</div>
                <div class="slash">/</div>
                <div class="date-seg" id="expMM">&nbsp;</div>
                <div class="slash">/</div>
                <div class="date-seg" id="expYY">&nbsp;</div>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet" id="sheet">
          <div class="labels-grid" id="labelsGrid"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="etiquetas.js"></script>
  
  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('Service Worker registrado com sucesso:', registration.scope);
          })
          .catch(error => {
            console.log('Falha ao registrar Service Worker:', error);
          });
      });
    }

    // Prompt para instalar PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Criar bot√£o de instala√ß√£o se n√£o existir
      if (!document.getElementById('installBtn')) {
        const installBtn = document.createElement('button');
        installBtn.id = 'installBtn';
        installBtn.textContent = 'üì± Instalar App';
        installBtn.className = 'primary';
        installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:1000;box-shadow:0 4px 12px rgba(37,99,235,0.4)';
        
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Usu√°rio ${outcome === 'accepted' ? 'aceitou' : 'recusou'} a instala√ß√£o`);
            deferredPrompt = null;
            installBtn.remove();
          }
        });
        
        document.body.appendChild(installBtn);
      }
    });

    window.addEventListener('appinstalled', () => {
      console.log('PWA instalado com sucesso!');
      const installBtn = document.getElementById('installBtn');
      if (installBtn) installBtn.remove();
    });
  </script>
</body>
</html>
